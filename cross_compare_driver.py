#! /usr/bin/env python3

from argparse import ArgumentParser
from subprocess import Popen, call, check_output
from itertools import combinations
from collections import defaultdict
import csv
import logging

parser = ArgumentParser(description="Compare many binaries to each other",)
parser.add_argument('-f', '--file', help="File listing binaries, one per line",
                    required=True)
parser.add_argument('-o', '--output', help="The base filename for the outputs",
                    required=True)
parser.add_argument('-n', '--number', help="The n value for n-grams", 
                    required=True)
parser.add_argument('-d', '--debug', action="store_true", 
                    help="Print debug messages")

args = parser.parse_args()

if args.debug:
    logging.basicConfig(level=logging.DEBUG)
else:
    logging.basicConfig(level=logging.ERROR)

logging.debug("Executing cross_compare_driver.py")
input_file = open(args.file, "r")
n = args.number
output_file = open(args.output+"."+n+".csv", "w")
file_list = list()

grams = list()
files = list()

# Read through the input file and run each binary through the n-gram program
for line in input_file:
    line = line.strip()
    # Run through n-gram parser
    out_name = line+"."+n+"gram"
    print("Making n-grams for "+line)
    cmd = ["./n_grams_bytes.py", "-n", n, "-o", out_name, line]
    if args.debug:
        cmd.append("-d")
    call(cmd)
    grams.append(out_name)
    files.append(out_name)
input_file.close()

table = defaultdict(dict)
#Now, run each binary against every other binary
for first, second in combinations(grams, 2):
    print(first+" x "+second)
    cmd = ["./compare_cluster.py", "-f", first, "-s", second]
    if args.debug:
        cmd.append("-d")
    output = float(check_output(cmd))
    table[first][second] = output
    table[second][first] = output
    table[first][first] = 1.0
    table[second][second] = 1.0

cw = csv.writer(output_file)
files.insert(0, "")
#Write the header to the file
cw.writerow(files)
del files[0]

#Go through the table and print out the cosine scores to fit a table.
logging.debug(str(table))
logging.debug(str(files))
for key in files:
    line = list()
    line.append(key)
    for item in files:
        logging.debug("%s, %s" % (key, item))
        line.append(table[key][item])
    cw.writerow(line)
