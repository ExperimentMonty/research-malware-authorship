#! /usr/bin/env python3

import argparse
import sys
import json
import math
import binascii
from collections import defaultdict
import logging

def main():
    parser = argparse.ArgumentParser(description="Create op-code-wise n-gram distribution",)
    parser.add_argument('-n', default=1, help="Size of n-grams")
    parser.add_argument('-o', '--output', default=None, help="File to write output to")
    parser.add_argument('input', help="The .obj file to be n-gram analyzed")
    parser.add_argument('--normalize', default=True, help="Normalize the vector before outputting", action="store_true")
    parser.add_argument('-d', '--debug', default=False, action="store_true")

    args = parser.parse_args()

    if args.debug:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.ERROR)

    file_name = args.input
    n = int(args.n)
    output = args.output

    distribution = defaultdict(int)
    gram = list()

    with open(file_name, "r") as f:
        for line in f:
            if len(gram) == n:
                gram.remove(gram[0])
            gram.append(line.strip())
            
            if len(gram) < n:
                continue
            else:    
                distribution['["'+'","'.join(gram)+'"]'] += 1

    logging.debug(distribution)

    if output is None:
        if args.normalize:
            for key, value in sorted(normalize(distribution).items()):
                print('%s %s' % (key, value))
        else:
            print(distribution)
        #print(json.dumps(distribution))
    else:
        outfile = open(output, "w")
        if args.normalize:
            for key, value in sorted(normalize(distribution).items()):
                outfile.write('%s %s\n' % (key, value))
        else:
            outfile.write(str(distribution))
            #json.dump(distribution, open(output, "w"))

def n_gram(f, n):
    # This function will take a file-like object f and an integer n and run an
    # n-gram analysis on the contents of f. It will return a dictionary of
    # n-grams as the keys, with the values of each n-gram being the count of the
    # n-grams.
    pass

def normalize(vector):
    sum = 0.0
    result = dict()
    for value in vector.values():
        sum += value**2
    sum = math.sqrt(sum)
    for key in vector.keys():
        result[key] = vector[key]/sum
    return result

if __name__ == "__main__":
    # I like defining functions at the end, so we're using this so I can do that
    main()
